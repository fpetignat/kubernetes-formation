# Architecture et Ressources Kubernetes - Schéma Complet

Ce document présente une vue d'ensemble complète de l'architecture Kubernetes et de toutes ses ressources principales avec des schémas visuels détaillés.

## Table des matières

- [1. Architecture globale d'un cluster Kubernetes](#1-architecture-globale-dun-cluster-kubernetes)
- [2. Hiérarchie des ressources](#2-hiérarchie-des-ressources)
- [3. Ressources par catégorie](#3-ressources-par-catégorie)
- [4. Relations entre les ressources](#4-relations-entre-les-ressources)
- [5. Flux de déploiement](#5-flux-de-déploiement)

---

## 1. Architecture globale d'un cluster Kubernetes

```
┌─────────────────────────────────────────────────────────────────────────────┐
│                         CLUSTER KUBERNETES                                   │
│                                                                              │
│  ┌────────────────────────────────────────────────────────────────────────┐ │
│  │                    CONTROL PLANE (Master Node)                         │ │
│  │                                                                        │ │
│  │  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  ┌───────────┐ │ │
│  │  │  API Server  │  │  Scheduler   │  │  Controller  │  │   etcd    │ │ │
│  │  │              │  │              │  │   Manager    │  │ (Storage) │ │ │
│  │  │  (kube-api)  │  │(kube-scheduler)│(kube-controller)│           │ │ │
│  │  └──────────────┘  └──────────────┘  └──────────────┘  └───────────┘ │ │
│  │         │                  │                  │                        │ │
│  └─────────┼──────────────────┼──────────────────┼────────────────────────┘ │
│            │                  │                  │                          │
│            └──────────────────┴──────────────────┘                          │
│                               │                                             │
│  ┌────────────────────────────┼─────────────────────────────────────────┐  │
│  │                    WORKER NODES                                      │  │
│  │                            │                                         │  │
│  │  ┌─────────────────────────▼────────────────┐                       │  │
│  │  │         Node 1                           │                       │  │
│  │  │  ┌────────────┐  ┌──────────────────┐   │                       │  │
│  │  │  │  kubelet   │  │  kube-proxy      │   │                       │  │
│  │  │  │            │  │  (networking)    │   │                       │  │
│  │  │  └────────────┘  └──────────────────┘   │                       │  │
│  │  │                                          │                       │  │
│  │  │  ┌────────────────────────────────────┐ │                       │  │
│  │  │  │   Container Runtime (Docker/CRI)   │ │                       │  │
│  │  │  └────────────────────────────────────┘ │                       │  │
│  │  │                                          │                       │  │
│  │  │  ┌──────────────────────────────────────────────────────┐       │  │
│  │  │  │              PODS                                     │       │  │
│  │  │  │  ┌─────────────┐  ┌─────────────┐  ┌─────────────┐  │       │  │
│  │  │  │  │   Pod 1     │  │   Pod 2     │  │   Pod 3     │  │       │  │
│  │  │  │  │  ┌────────┐ │  │  ┌────────┐ │  │  ┌────────┐ │  │       │  │
│  │  │  │  │  │Container│ │  │  │Container│ │  │  │Container│ │  │       │  │
│  │  │  │  │  └────────┘ │  │  └────────┘ │  │  └────────┘ │  │       │  │
│  │  │  │  └─────────────┘  └─────────────┘  └─────────────┘  │       │  │
│  │  │  └──────────────────────────────────────────────────────┘       │  │
│  │  └──────────────────────────────────────┘                          │  │
│  │                                                                     │  │
│  │  ┌─────────────────────────────────────┐   ┌─────────────────────┐│  │
│  │  │         Node 2                      │   │      Node N         ││  │
│  │  │  (Same components as Node 1)        │...│  (Same components)  ││  │
│  │  └─────────────────────────────────────┘   └─────────────────────┘│  │
│  └─────────────────────────────────────────────────────────────────────┘  │
│                                                                            │
└────────────────────────────────────────────────────────────────────────────┘
```

### Composants du Control Plane

- **API Server** : Point d'entrée pour toutes les commandes kubectl et communications
- **Scheduler** : Planifie les Pods sur les Nodes appropriés
- **Controller Manager** : Gère les contrôleurs (Deployment, ReplicaSet, etc.)
- **etcd** : Base de données clé-valeur distribuée stockant l'état du cluster

### Composants des Worker Nodes

- **kubelet** : Agent qui s'assure que les conteneurs tournent dans les Pods
- **kube-proxy** : Gère les règles réseau et le routage
- **Container Runtime** : Exécute les conteneurs (Docker, containerd, CRI-O)

---

## 2. Hiérarchie des ressources

```
                           CLUSTER
                              │
        ┌─────────────────────┼─────────────────────┐
        │                     │                     │
    NAMESPACES            NODES              PERSISTENT VOLUMES
        │                     │                     │
        │                     └────────┐            │
        │                              │            │
┌───────┴────────┐                     │            │
│                │                     │            │
│   ┌────────────▼────────────┐        │            │
│   │      WORKLOADS          │        │            │
│   │  ┌──────────────────┐   │        │            │
│   │  │  Deployments     │───┼────────┤            │
│   │  └────────┬─────────┘   │        │            │
│   │           │             │        │            │
│   │  ┌────────▼─────────┐   │        │            │
│   │  │  ReplicaSets     │───┼────────┤            │
│   │  └────────┬─────────┘   │        │            │
│   │           │             │        │            │
│   │  ┌────────▼─────────┐   │        │            │
│   │  │  Pods            │───┼────────┤            │
│   │  └──────────────────┘   │        │            │
│   │                         │        │            │
│   │  ┌──────────────────┐   │        │            │
│   │  │  StatefulSets    │───┼────────┤            │
│   │  └──────────────────┘   │        │            │
│   │                         │        │            │
│   │  ┌──────────────────┐   │        │            │
│   │  │  DaemonSets      │───┼────────┤            │
│   │  └──────────────────┘   │        │            │
│   │                         │        │            │
│   │  ┌──────────────────┐   │        │            │
│   │  │  Jobs/CronJobs   │───┼────────┤            │
│   │  └──────────────────┘   │        │            │
│   └─────────────────────────┘        │            │
│                                      │            │
│   ┌─────────────────────────┐        │            │
│   │      SERVICES           │        │            │
│   │  ┌──────────────────┐   │        │            │
│   │  │  ClusterIP       │   │        │            │
│   │  ├──────────────────┤   │        │            │
│   │  │  NodePort        │   │        │            │
│   │  ├──────────────────┤   │        │            │
│   │  │  LoadBalancer    │   │        │            │
│   │  ├──────────────────┤   │        │            │
│   │  │  ExternalName    │   │        │            │
│   │  └──────────────────┘   │        │            │
│   └─────────────────────────┘        │            │
│                                      │            │
│   ┌─────────────────────────┐        │            │
│   │      INGRESS            │        │            │
│   │  ┌──────────────────┐   │        │            │
│   │  │  Ingress Rules   │   │        │            │
│   │  │  HTTP/HTTPS      │   │        │            │
│   │  └──────────────────┘   │        │            │
│   └─────────────────────────┘        │            │
│                                      │            │
│   ┌─────────────────────────┐        │    ┌───────▼────────┐
│   │    CONFIGURATION        │        │    │  PVC (Claims)  │
│   │  ┌──────────────────┐   │        │    └────────────────┘
│   │  │  ConfigMaps      │   │        │            │
│   │  ├──────────────────┤   │        │            │
│   │  │  Secrets         │   │        │    ┌───────▼────────┐
│   │  └──────────────────┘   │        │    │ Storage Classes│
│   └─────────────────────────┘        │    └────────────────┘
│                                      │
│   ┌─────────────────────────┐        │
│   │      SECURITY           │        │
│   │  ┌──────────────────┐   │        │
│   │  │ ServiceAccounts  │   │        │
│   │  ├──────────────────┤   │        │
│   │  │ Roles            │   │        │
│   │  ├──────────────────┤   │        │
│   │  │ RoleBindings     │   │        │
│   │  ├──────────────────┤   │        │
│   │  │ NetworkPolicies  │   │        │
│   │  └──────────────────┘   │        │
│   └─────────────────────────┘        │
│                                      │
│   ┌─────────────────────────┐        │
│   │   AUTOSCALING           │        │
│   │  ┌──────────────────┐   │        │
│   │  │  HPA             │   │        │
│   │  ├──────────────────┤   │        │
│   │  │  VPA             │   │        │
│   │  ├──────────────────┤   │        │
│   │  │  PodDisruption   │   │        │
│   │  │  Budgets         │   │        │
│   │  └──────────────────┘   │        │
│   └─────────────────────────┘        │
│                                      │
└──────────────────────────────────────┘
```

---

## 3. Ressources par catégorie

### 3.1 Workloads (Charges de travail)

```
┌────────────────────────────────────────────────────────────────┐
│                      WORKLOAD RESOURCES                        │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │  POD (Unité de base)                                    │  │
│  │  ┌──────────────────────────────────────────────────┐   │  │
│  │  │  • Un ou plusieurs conteneurs                    │   │  │
│  │  │  • Adresse IP partagée                           │   │  │
│  │  │  │  Volumes partagés                             │   │  │
│  │  │  • Même namespace réseau                         │   │  │
│  │  │                                                   │   │  │
│  │  │  ┌──────────┐  ┌──────────┐  ┌──────────┐       │   │  │
│  │  │  │Container1│  │Container2│  │ InitCont │       │   │  │
│  │  │  └──────────┘  └──────────┘  └──────────┘       │   │  │
│  │  └──────────────────────────────────────────────────┘   │  │
│  └─────────────────────────────────────────────────────────┘  │
│                                                                │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │  DEPLOYMENT (Déploiement déclaratif)                    │  │
│  │  ┌──────────────────────────────────────────────────┐   │  │
│  │  │  • Gère les ReplicaSets                          │   │  │
│  │  │  • Rolling updates                               │   │  │
│  │  │  • Rollback automatique                          │   │  │
│  │  │  • Stratégies de déploiement                     │   │  │
│  │  │                                                   │   │  │
│  │  │  Deployment                                      │   │  │
│  │  │       │                                           │   │  │
│  │  │       ▼                                           │   │  │
│  │  │  ReplicaSet (v1) ────► Pods (3 replicas)         │   │  │
│  │  │       │                                           │   │  │
│  │  │       ▼                                           │   │  │
│  │  │  ReplicaSet (v2) ────► Pods (3 replicas)         │   │  │
│  │  └──────────────────────────────────────────────────┘   │  │
│  └─────────────────────────────────────────────────────────┘  │
│                                                                │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │  REPLICASET (Ensemble de répliques)                     │  │
│  │  ┌──────────────────────────────────────────────────┐   │  │
│  │  │  • Maintient N répliques de Pods                 │   │  │
│  │  │  • Sélecteur de labels                           │   │  │
│  │  │  • Auto-réparation                               │   │  │
│  │  │                                                   │   │  │
│  │  │  ReplicaSet (replicas: 3)                        │   │  │
│  │  │       │                                           │   │  │
│  │  │       ├──────► Pod 1                              │   │  │
│  │  │       ├──────► Pod 2                              │   │  │
│  │  │       └──────► Pod 3                              │   │  │
│  │  └──────────────────────────────────────────────────┘   │  │
│  └─────────────────────────────────────────────────────────┘  │
│                                                                │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │  STATEFULSET (Pour applications avec état)              │  │
│  │  ┌──────────────────────────────────────────────────┐   │  │
│  │  │  • Identité stable et unique                     │   │  │
│  │  │  • Ordre de déploiement garanti                  │   │  │
│  │  │  • Stockage persistant stable                    │   │  │
│  │  │  • DNS stable (pod-0, pod-1, ...)               │   │  │
│  │  │                                                   │   │  │
│  │  │  StatefulSet: mydb                               │   │  │
│  │  │       │                                           │   │  │
│  │  │       ├──────► mydb-0 (PVC: data-mydb-0)         │   │  │
│  │  │       ├──────► mydb-1 (PVC: data-mydb-1)         │   │  │
│  │  │       └──────► mydb-2 (PVC: data-mydb-2)         │   │  │
│  │  └──────────────────────────────────────────────────┘   │  │
│  └─────────────────────────────────────────────────────────┘  │
│                                                                │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │  DAEMONSET (Un Pod par Node)                            │  │
│  │  ┌──────────────────────────────────────────────────┐   │  │
│  │  │  • Un Pod sur chaque Node                        │   │  │
│  │  │  • Utile pour: monitoring, logging, network      │   │  │
│  │  │  • Respecte les node selectors et taints         │   │  │
│  │  │                                                   │   │  │
│  │  │  DaemonSet: fluentd-logger                       │   │  │
│  │  │       │                                           │   │  │
│  │  │       ├──────► Pod on Node 1                      │   │  │
│  │  │       ├──────► Pod on Node 2                      │   │  │
│  │  │       └──────► Pod on Node 3                      │   │  │
│  │  └──────────────────────────────────────────────────┘   │  │
│  └─────────────────────────────────────────────────────────┘  │
│                                                                │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │  JOB (Tâche ponctuelle)                                 │  │
│  │  ┌──────────────────────────────────────────────────┐   │  │
│  │  │  • Exécute une tâche jusqu'à complétion          │   │  │
│  │  │  • Peut être parallélisé                         │   │  │
│  │  │  • Retry automatique en cas d'échec              │   │  │
│  │  │                                                   │   │  │
│  │  │  Job: batch-import                               │   │  │
│  │  │       │                                           │   │  │
│  │  │       └──────► Pod ──► [Complete] ✓              │   │  │
│  │  └──────────────────────────────────────────────────┘   │  │
│  └─────────────────────────────────────────────────────────┘  │
│                                                                │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │  CRONJOB (Tâche planifiée)                              │  │
│  │  ┌──────────────────────────────────────────────────┐   │  │
│  │  │  • Schedule basé sur cron                        │   │  │
│  │  │  • Crée des Jobs périodiquement                  │   │  │
│  │  │  • Backup, rapports, nettoyage                   │   │  │
│  │  │                                                   │   │  │
│  │  │  CronJob: "0 2 * * *" (2h du matin)              │   │  │
│  │  │       │                                           │   │  │
│  │  │       ├──────► Job (2025-01-01)                   │   │  │
│  │  │       ├──────► Job (2025-01-02)                   │   │  │
│  │  │       └──────► Job (2025-01-03)                   │   │  │
│  │  └──────────────────────────────────────────────────┘   │  │
│  └─────────────────────────────────────────────────────────┘  │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```

### 3.2 Services et Networking

```
┌────────────────────────────────────────────────────────────────┐
│                  SERVICES & NETWORKING                         │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │  SERVICE: ClusterIP (Défaut - Interne uniquement)       │  │
│  │  ┌──────────────────────────────────────────────────┐   │  │
│  │  │                                                   │   │  │
│  │  │  Service ClusterIP (10.96.0.10)                  │   │  │
│  │  │          │                                        │   │  │
│  │  │          ├──────► Pod 1 (10.244.1.5)             │   │  │
│  │  │          ├──────► Pod 2 (10.244.1.6)             │   │  │
│  │  │          └──────► Pod 3 (10.244.2.7)             │   │  │
│  │  │                                                   │   │  │
│  │  │  • IP virtuelle stable dans le cluster           │   │  │
│  │  │  • Load balancing automatique                    │   │  │
│  │  │  • Découverte via DNS (my-service.namespace)     │   │  │
│  │  └──────────────────────────────────────────────────┘   │  │
│  └─────────────────────────────────────────────────────────┘  │
│                                                                │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │  SERVICE: NodePort (Accessible de l'extérieur)          │  │
│  │  ┌──────────────────────────────────────────────────┐   │  │
│  │  │                                                   │   │  │
│  │  │  Client ──► Node IP:30080 ──┐                    │   │  │
│  │  │                              │                    │   │  │
│  │  │  Service NodePort ◄──────────┘                    │   │  │
│  │  │  (ClusterIP: 10.96.0.10, NodePort: 30080)        │   │  │
│  │  │          │                                        │   │  │
│  │  │          ├──────► Pod 1                           │   │  │
│  │  │          ├──────► Pod 2                           │   │  │
│  │  │          └──────► Pod 3                           │   │  │
│  │  │                                                   │   │  │
│  │  │  • Port ouvert sur tous les Nodes (30000-32767)  │   │  │
│  │  │  • Accessible via <NodeIP>:<NodePort>            │   │  │
│  │  └──────────────────────────────────────────────────┘   │  │
│  └─────────────────────────────────────────────────────────┘  │
│                                                                │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │  SERVICE: LoadBalancer (Cloud Provider)                 │  │
│  │  ┌──────────────────────────────────────────────────┐   │  │
│  │  │                                                   │   │  │
│  │  │  Internet ──► Cloud LB (IP: 203.0.113.10)        │   │  │
│  │  │                    │                              │   │  │
│  │  │  Service LoadBalancer ◄────┘                      │   │  │
│  │  │  (NodePort + External IP)                         │   │  │
│  │  │          │                                        │   │  │
│  │  │          ├──────► Pod 1                           │   │  │
│  │  │          ├──────► Pod 2                           │   │  │
│  │  │          └──────► Pod 3                           │   │  │
│  │  │                                                   │   │  │
│  │  │  • Provisionne un Load Balancer externe          │   │  │
│  │  │  • Disponible sur AWS, GCP, Azure                │   │  │
│  │  └──────────────────────────────────────────────────┘   │  │
│  └─────────────────────────────────────────────────────────┘  │
│                                                                │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │  INGRESS (HTTP/HTTPS Routing)                           │  │
│  │  ┌──────────────────────────────────────────────────┐   │  │
│  │  │                                                   │   │  │
│  │  │  Internet ──► Ingress Controller                  │   │  │
│  │  │                    │                              │   │  │
│  │  │              Ingress Rules                        │   │  │
│  │  │                    │                              │   │  │
│  │  │     ┌──────────────┼──────────────┐               │   │  │
│  │  │     │              │              │               │   │  │
│  │  │  app.com/       app.com/api   shop.com/          │   │  │
│  │  │     │              │              │               │   │  │
│  │  │  Service A     Service B     Service C            │   │  │
│  │  │     │              │              │               │   │  │
│  │  │  Pods A         Pods B         Pods C             │   │  │
│  │  │                                                   │   │  │
│  │  │  • Routage HTTP(S) basé sur host/path            │   │  │
│  │  │  • TLS/SSL termination                           │   │  │
│  │  │  • Virtual hosting                               │   │  │
│  │  └──────────────────────────────────────────────────┘   │  │
│  └─────────────────────────────────────────────────────────┘  │
│                                                                │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │  NETWORK POLICY (Contrôle du trafic réseau)             │  │
│  │  ┌──────────────────────────────────────────────────┐   │  │
│  │  │                                                   │   │  │
│  │  │  ┌─────────────┐         ┌─────────────┐         │   │  │
│  │  │  │ Frontend    │ ──✓──► │ Backend     │         │   │  │
│  │  │  │ Pods        │         │ Pods        │         │   │  │
│  │  │  └─────────────┘         └─────────────┘         │   │  │
│  │  │         │                       ▲                │   │  │
│  │  │         │                       │                │   │  │
│  │  │         └──────────✗────────────┘                │   │  │
│  │  │       (Bloqué par NetworkPolicy)                 │   │  │
│  │  │                                                   │   │  │
│  │  │         ┌─────────────┐                          │   │  │
│  │  │    ✗───│   Internet  │                          │   │  │
│  │  │         └─────────────┘                          │   │  │
│  │  │                                                   │   │  │
│  │  │  • Contrôle Ingress/Egress par namespace/pod     │   │  │
│  │  │  • Basé sur labels et selectors                  │   │  │
│  │  │  • Isolation réseau fine                         │   │  │
│  │  └──────────────────────────────────────────────────┘   │  │
│  └─────────────────────────────────────────────────────────┘  │
│                                                                │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │  DNS (Service Discovery)                                │  │
│  │  ┌──────────────────────────────────────────────────┐   │  │
│  │  │                                                   │   │  │
│  │  │  CoreDNS                                          │   │  │
│  │  │     │                                             │   │  │
│  │  │     ├─► my-service.default.svc.cluster.local     │   │  │
│  │  │     ├─► my-service.production.svc.cluster.local  │   │  │
│  │  │     └─► pod-ip.namespace.pod.cluster.local       │   │  │
│  │  │                                                   │   │  │
│  │  │  • Résolution DNS automatique des services       │   │  │
│  │  │  • Format: <service>.<namespace>.svc.cluster.local│  │
│  │  └──────────────────────────────────────────────────┘   │  │
│  └─────────────────────────────────────────────────────────┘  │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```

### 3.3 Configuration et Secrets

```
┌────────────────────────────────────────────────────────────────┐
│               CONFIGURATION & SECRETS                          │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │  CONFIGMAP (Configuration non-sensible)                  │  │
│  │  ┌──────────────────────────────────────────────────┐   │  │
│  │  │                                                   │   │  │
│  │  │  ConfigMap: app-config                           │   │  │
│  │  │  ┌─────────────────────────────────┐             │   │  │
│  │  │  │ data:                           │             │   │  │
│  │  │  │   database_url: "db.example"    │             │   │  │
│  │  │  │   max_connections: "100"        │             │   │  │
│  │  │  │   log_level: "info"             │             │   │  │
│  │  │  │   app.properties: |             │             │   │  │
│  │  │  │     key1=value1                 │             │   │  │
│  │  │  │     key2=value2                 │             │   │  │
│  │  │  └─────────────────────────────────┘             │   │  │
│  │  │          │                                        │   │  │
│  │  │          ▼                                        │   │  │
│  │  │  ┌─────────────────────────────────┐             │   │  │
│  │  │  │      POD                        │             │   │  │
│  │  │  │  ┌──────────────────────────┐   │             │   │  │
│  │  │  │  │ Variables d'environnement│   │             │   │  │
│  │  │  │  │ ou                       │   │             │   │  │
│  │  │  │  │ Fichiers montés          │   │             │   │  │
│  │  │  │  └──────────────────────────┘   │             │   │  │
│  │  │  └─────────────────────────────────┘             │   │  │
│  │  │                                                   │   │  │
│  │  │  Utilisations:                                   │   │  │
│  │  │  • Variables d'environnement (envFrom)           │   │  │
│  │  │  • Volumes montés (volumeMounts)                 │   │  │
│  │  │  • Arguments de commande                         │   │  │
│  │  └──────────────────────────────────────────────────┘   │  │
│  └─────────────────────────────────────────────────────────┘  │
│                                                                │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │  SECRET (Données sensibles encodées)                    │  │
│  │  ┌──────────────────────────────────────────────────┐   │  │
│  │  │                                                   │   │  │
│  │  │  Secret: db-credentials                          │   │  │
│  │  │  ┌─────────────────────────────────┐             │   │  │
│  │  │  │ type: Opaque                    │             │   │  │
│  │  │  │ data: (base64 encoded)          │             │   │  │
│  │  │  │   username: YWRtaW4=            │             │   │  │
│  │  │  │   password: cGFzc3dvcmQ=        │             │   │  │
│  │  │  │   tls.crt: <cert-data>          │             │   │  │
│  │  │  │   tls.key: <key-data>           │             │   │  │
│  │  │  └─────────────────────────────────┘             │   │  │
│  │  │          │                                        │   │  │
│  │  │          ▼                                        │   │  │
│  │  │  ┌─────────────────────────────────┐             │   │  │
│  │  │  │      POD                        │             │   │  │
│  │  │  │  ┌──────────────────────────┐   │             │   │  │
│  │  │  │  │ Données décodées         │   │             │   │  │
│  │  │  │  │ automatiquement          │   │             │   │  │
│  │  │  │  └──────────────────────────┘   │             │   │  │
│  │  │  └─────────────────────────────────┘             │   │  │
│  │  │                                                   │   │  │
│  │  │  Types de Secrets:                               │   │  │
│  │  │  • Opaque (générique)                            │   │  │
│  │  │  • kubernetes.io/dockerconfigjson (registry)     │   │  │
│  │  │  • kubernetes.io/tls (certificats)               │   │  │
│  │  │  • kubernetes.io/service-account-token           │   │  │
│  │  │  • kubernetes.io/basic-auth                      │   │  │
│  │  └──────────────────────────────────────────────────┘   │  │
│  └─────────────────────────────────────────────────────────┘  │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```

### 3.4 Stockage Persistant

```
┌────────────────────────────────────────────────────────────────┐
│                  STORAGE (Stockage)                            │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │  Flux complet du stockage persistant                     │  │
│  │                                                           │  │
│  │  ┌───────────────────────────────────────────────────┐   │  │
│  │  │ 1. STORAGECLASS (Template de provisionnement)    │   │  │
│  │  │    ┌─────────────────────────────────────────┐    │   │  │
│  │  │    │ name: fast-ssd                          │    │   │  │
│  │  │    │ provisioner: kubernetes.io/aws-ebs      │    │   │  │
│  │  │    │ parameters:                             │    │   │  │
│  │  │    │   type: gp3                             │    │   │  │
│  │  │    │   iops: "3000"                          │    │   │  │
│  │  │    └─────────────────────────────────────────┘    │   │  │
│  │  └───────────────────────────────────────────────────┘   │  │
│  │                      │                                    │  │
│  │                      ▼ (provisionnement dynamique)        │  │
│  │  ┌───────────────────────────────────────────────────┐   │  │
│  │  │ 2. PERSISTENTVOLUME (PV - Stockage réel)          │   │  │
│  │  │    ┌─────────────────────────────────────────┐    │   │  │
│  │  │    │ name: pv-mysql-001                      │    │   │  │
│  │  │    │ capacity: 10Gi                          │    │   │  │
│  │  │    │ accessModes: ReadWriteOnce              │    │   │  │
│  │  │    │ persistentVolumeReclaimPolicy: Retain   │    │   │  │
│  │  │    │ storageClassName: fast-ssd              │    │   │  │
│  │  │    │ hostPath/nfs/awsEBS/gcePD/etc           │    │   │  │
│  │  │    └─────────────────────────────────────────┘    │   │  │
│  │  └───────────────────────────────────────────────────┘   │  │
│  │                      ▲                                    │  │
│  │                      │ (binding)                          │  │
│  │                      │                                    │  │
│  │  ┌───────────────────┴───────────────────────────────┐   │  │
│  │  │ 3. PERSISTENTVOLUMECLAIM (PVC - Demande)          │   │  │
│  │  │    ┌─────────────────────────────────────────┐    │   │  │
│  │  │    │ name: mysql-pvc                         │    │   │  │
│  │  │    │ accessModes: ReadWriteOnce              │    │   │  │
│  │  │    │ resources:                              │    │   │  │
│  │  │    │   requests:                             │    │   │  │
│  │  │    │     storage: 10Gi                       │    │   │  │
│  │  │    │ storageClassName: fast-ssd              │    │   │  │
│  │  │    └─────────────────────────────────────────┘    │   │  │
│  │  └───────────────────────────────────────────────────┘   │  │
│  │                      │                                    │  │
│  │                      ▼ (utilisé par)                      │  │
│  │  ┌───────────────────────────────────────────────────┐   │  │
│  │  │ 4. POD (Consomme le volume)                       │   │  │
│  │  │    ┌─────────────────────────────────────────┐    │   │  │
│  │  │    │ spec:                                   │    │   │  │
│  │  │    │   volumes:                              │    │   │  │
│  │  │    │   - name: mysql-storage                 │    │   │  │
│  │  │    │     persistentVolumeClaim:              │    │   │  │
│  │  │    │       claimName: mysql-pvc              │    │   │  │
│  │  │    │   containers:                           │    │   │  │
│  │  │    │   - name: mysql                         │    │   │  │
│  │  │    │     volumeMounts:                       │    │   │  │
│  │  │    │     - mountPath: /var/lib/mysql         │    │   │  │
│  │  │    │       name: mysql-storage               │    │   │  │
│  │  │    └─────────────────────────────────────────┘    │   │  │
│  │  └───────────────────────────────────────────────────┘   │  │
│  └─────────────────────────────────────────────────────────┘  │
│                                                                │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │  Modes d'accès (Access Modes)                            │  │
│  │                                                           │  │
│  │  • ReadWriteOnce (RWO) : 1 node en lecture/écriture      │  │
│  │  • ReadOnlyMany (ROX)  : N nodes en lecture seule        │  │
│  │  • ReadWriteMany (RWX) : N nodes en lecture/écriture     │  │
│  │  • ReadWriteOncePod    : 1 pod en lecture/écriture       │  │
│  └─────────────────────────────────────────────────────────┘  │
│                                                                │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │  Politiques de réclamation (Reclaim Policies)            │  │
│  │                                                           │  │
│  │  • Retain : Volume conservé après suppression du PVC     │  │
│  │  • Delete : Volume supprimé automatiquement              │  │
│  │  • Recycle : Données effacées, volume réutilisable       │  │
│  └─────────────────────────────────────────────────────────┘  │
│                                                                │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │  Types de volumes (Volume Types)                         │  │
│  │                                                           │  │
│  │  Éphémères (dans le Pod):                                │  │
│  │  • emptyDir : Vide au démarrage, partagé entre conteneurs│  │
│  │  • configMap : Depuis ConfigMap                          │  │
│  │  • secret : Depuis Secret                                │  │
│  │  • downwardAPI : Métadonnées du Pod                      │  │
│  │                                                           │  │
│  │  Persistants (PV):                                        │  │
│  │  • hostPath : Répertoire du node (dev/test uniquement)   │  │
│  │  • nfs : Network File System                             │  │
│  │  • awsElasticBlockStore (AWS EBS)                        │  │
│  │  • gcePersistentDisk (GCP PD)                            │  │
│  │  • azureDisk / azureFile (Azure)                         │  │
│  │  • cephfs, glusterfs : Systèmes distribués               │  │
│  │  • iscsi, fc : SAN storage                               │  │
│  │  • csi : Container Storage Interface (plugins)           │  │
│  └─────────────────────────────────────────────────────────┘  │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```

### 3.5 Sécurité et RBAC

```
┌────────────────────────────────────────────────────────────────┐
│                  SECURITY & RBAC                               │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │  RBAC (Role-Based Access Control)                        │  │
│  │                                                           │  │
│  │  ┌───────────────────────────────────────────────────┐   │  │
│  │  │ 1. SERVICEACCOUNT (Identité)                     │   │  │
│  │  │    ┌─────────────────────────────────────────┐    │   │  │
│  │  │    │ name: my-app-sa                         │    │   │  │
│  │  │    │ namespace: production                   │    │   │  │
│  │  │    │ secrets: [token-abc123]                 │    │   │  │
│  │  │    └─────────────────────────────────────────┘    │   │  │
│  │  └───────────────────────────────────────────────────┘   │  │
│  │                      │                                    │  │
│  │                      ▼ (utilisé par les Pods)             │  │
│  │  ┌───────────────────────────────────────────────────┐   │  │
│  │  │         POD                                       │   │  │
│  │  │    spec:                                          │   │  │
│  │  │      serviceAccountName: my-app-sa                │   │  │
│  │  └───────────────────────────────────────────────────┘   │  │
│  │                      │                                    │  │
│  │                      ▼ (lié via)                          │  │
│  │  ┌───────────────────────────────────────────────────┐   │  │
│  │  │ 2. ROLEBINDING (Lie ServiceAccount et Role)      │   │  │
│  │  │    ┌─────────────────────────────────────────┐    │   │  │
│  │  │    │ name: my-app-binding                    │    │   │  │
│  │  │    │ subjects:                               │    │   │  │
│  │  │    │   - kind: ServiceAccount                │    │   │  │
│  │  │    │     name: my-app-sa                     │    │   │  │
│  │  │    │ roleRef:                                │    │   │  │
│  │  │    │   kind: Role                            │    │   │  │
│  │  │    │   name: pod-reader                      │    │   │  │
│  │  │    └─────────────────────────────────────────┘    │   │  │
│  │  └───────────────────────────────────────────────────┘   │  │
│  │                      │                                    │  │
│  │                      ▼ (référence)                        │  │
│  │  ┌───────────────────────────────────────────────────┐   │  │
│  │  │ 3. ROLE (Permissions dans namespace)             │   │  │
│  │  │    ┌─────────────────────────────────────────┐    │   │  │
│  │  │    │ name: pod-reader                        │    │   │  │
│  │  │    │ rules:                                  │    │   │  │
│  │  │    │ - apiGroups: [""]                       │    │   │  │
│  │  │    │   resources: ["pods"]                   │    │   │  │
│  │  │    │   verbs: ["get", "list", "watch"]       │    │   │  │
│  │  │    │ - apiGroups: ["apps"]                   │    │   │  │
│  │  │    │   resources: ["deployments"]            │    │   │  │
│  │  │    │   verbs: ["get", "list"]                │    │   │  │
│  │  │    └─────────────────────────────────────────┘    │   │  │
│  │  └───────────────────────────────────────────────────┘   │  │
│  └─────────────────────────────────────────────────────────┘  │
│                                                                │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │  CLUSTERROLE & CLUSTERROLEBINDING (Niveau cluster)      │  │
│  │                                                           │  │
│  │  ┌───────────────────────────────────────────────────┐   │  │
│  │  │ CLUSTERROLE (Permissions à travers tout le cluster)│ │  │
│  │  │    ┌─────────────────────────────────────────┐    │   │  │
│  │  │    │ name: cluster-admin                     │    │   │  │
│  │  │    │ rules:                                  │    │   │  │
│  │  │    │ - apiGroups: ["*"]                      │    │   │  │
│  │  │    │   resources: ["*"]                      │    │   │  │
│  │  │    │   verbs: ["*"]                          │    │   │  │
│  │  │    └─────────────────────────────────────────┘    │   │  │
│  │  └───────────────────────────────────────────────────┘   │  │
│  │                      │                                    │  │
│  │                      ▼                                    │  │
│  │  ┌───────────────────────────────────────────────────┐   │  │
│  │  │ CLUSTERROLEBINDING                                │   │  │
│  │  │    ┌─────────────────────────────────────────┐    │   │  │
│  │  │    │ subjects:                               │    │   │  │
│  │  │    │   - kind: User                          │    │   │  │
│  │  │    │     name: admin@example.com             │    │   │  │
│  │  │    │ roleRef:                                │    │   │  │
│  │  │    │   kind: ClusterRole                     │    │   │  │
│  │  │    │   name: cluster-admin                   │    │   │  │
│  │  │    └─────────────────────────────────────────┘    │   │  │
│  │  └───────────────────────────────────────────────────┘   │  │
│  └─────────────────────────────────────────────────────────┘  │
│                                                                │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │  SECURITY CONTEXT (Sécurité des Pods/Conteneurs)        │  │
│  │  ┌──────────────────────────────────────────────────┐   │  │
│  │  │                                                   │   │  │
│  │  │  Pod Security Context:                           │   │  │
│  │  │  • runAsUser: 1000 (UID non-root)                │   │  │
│  │  │  • runAsGroup: 3000                              │   │  │
│  │  │  • fsGroup: 2000 (permissions volumes)           │   │  │
│  │  │  • seccompProfile: RuntimeDefault                │   │  │
│  │  │                                                   │   │  │
│  │  │  Container Security Context:                     │   │  │
│  │  │  • runAsNonRoot: true                            │   │  │
│  │  │  • readOnlyRootFilesystem: true                  │   │  │
│  │  │  • allowPrivilegeEscalation: false               │   │  │
│  │  │  • capabilities:                                 │   │  │
│  │  │      drop: ["ALL"]                               │   │  │
│  │  │      add: ["NET_BIND_SERVICE"]                   │   │  │
│  │  └──────────────────────────────────────────────────┘   │  │
│  └─────────────────────────────────────────────────────────┘  │
│                                                                │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │  POD SECURITY STANDARDS                                  │  │
│  │  ┌──────────────────────────────────────────────────┐   │  │
│  │  │                                                   │   │  │
│  │  │  Niveaux (appliqués au namespace):               │   │  │
│  │  │                                                   │   │  │
│  │  │  ┌─────────────────────────────────────────┐     │   │  │
│  │  │  │ Privileged (Pas de restrictions)       │     │   │  │
│  │  │  │ • Tout est permis                       │     │   │  │
│  │  │  └─────────────────────────────────────────┘     │   │  │
│  │  │  ┌─────────────────────────────────────────┐     │   │  │
│  │  │  │ Baseline (Restrictions minimales)       │     │   │  │
│  │  │  │ • Empêche escalade de privilèges        │     │   │  │
│  │  │  │ • Pas de hostPath, hostNetwork          │     │   │  │
│  │  │  └─────────────────────────────────────────┘     │   │  │
│  │  │  ┌─────────────────────────────────────────┐     │   │  │
│  │  │  │ Restricted (Strictement sécurisé)       │     │   │  │
│  │  │  │ • runAsNonRoot obligatoire              │     │   │  │
│  │  │  │ • Volumes restreints                    │     │   │  │
│  │  │  │ • Capabilities limitées                 │     │   │  │
│  │  │  └─────────────────────────────────────────┘     │   │  │
│  │  │                                                   │   │  │
│  │  │  Modes: enforce (bloquer), audit, warn           │   │  │
│  │  └──────────────────────────────────────────────────┘   │  │
│  └─────────────────────────────────────────────────────────┘  │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```

### 3.6 Autoscaling et Disponibilité

```
┌────────────────────────────────────────────────────────────────┐
│             AUTOSCALING & AVAILABILITY                         │
├────────────────────────────────────────────────────────────────┤
│                                                                │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │  HPA (Horizontal Pod Autoscaler)                         │  │
│  │  ┌──────────────────────────────────────────────────┐   │  │
│  │  │                                                   │   │  │
│  │  │  HPA: web-app-hpa                                │   │  │
│  │  │    scaleTargetRef: web-deployment                │   │  │
│  │  │    minReplicas: 2                                │   │  │
│  │  │    maxReplicas: 10                               │   │  │
│  │  │    metrics:                                      │   │  │
│  │  │    - CPU: 70%                                    │   │  │
│  │  │    - Memory: 80%                                 │   │  │
│  │  │    - Custom: requests-per-second > 1000          │   │  │
│  │  │                                                   │   │  │
│  │  │  ┌──────────────────────────────────────┐        │   │  │
│  │  │  │  Charge faible (CPU: 30%)            │        │   │  │
│  │  │  │  Replicas: 2 (minimum)               │        │   │  │
│  │  │  │  ┌────┐  ┌────┐                      │        │   │  │
│  │  │  │  │Pod1│  │Pod2│                      │        │   │  │
│  │  │  │  └────┘  └────┘                      │        │   │  │
│  │  │  └──────────────────────────────────────┘        │   │  │
│  │  │                    │                             │   │  │
│  │  │                    ▼ (scale up)                  │   │  │
│  │  │  ┌──────────────────────────────────────┐        │   │  │
│  │  │  │  Charge élevée (CPU: 85%)            │        │   │  │
│  │  │  │  Replicas: 7 (auto-scaled)           │        │   │  │
│  │  │  │  ┌────┐┌────┐┌────┐┌────┐            │        │   │  │
│  │  │  │  │Pod1││Pod2││Pod3││Pod4│...         │        │   │  │
│  │  │  │  └────┘└────┘└────┘└────┘            │        │   │  │
│  │  │  └──────────────────────────────────────┘        │   │  │
│  │  │                                                   │   │  │
│  │  │  • Basé sur métriques (CPU, RAM, custom)         │   │  │
│  │  │  • Scaling automatique en fonction de la charge  │   │  │
│  │  │  • Cooldown période pour éviter flapping         │   │  │
│  │  └──────────────────────────────────────────────────┘   │  │
│  └─────────────────────────────────────────────────────────┘  │
│                                                                │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │  VPA (Vertical Pod Autoscaler)                           │  │
│  │  ┌──────────────────────────────────────────────────┐   │  │
│  │  │                                                   │   │  │
│  │  │  VPA: db-vpa                                     │   │  │
│  │  │    targetRef: db-deployment                      │   │  │
│  │  │    updateMode: Auto                              │   │  │
│  │  │                                                   │   │  │
│  │  │  ┌──────────────────────────────────────┐        │   │  │
│  │  │  │  Initial                             │        │   │  │
│  │  │  │  ┌────────────────┐                  │        │   │  │
│  │  │  │  │   Pod          │                  │        │   │  │
│  │  │  │  │   CPU: 500m    │                  │        │   │  │
│  │  │  │  │   RAM: 512Mi   │                  │        │   │  │
│  │  │  │  └────────────────┘                  │        │   │  │
│  │  │  └──────────────────────────────────────┘        │   │  │
│  │  │                    │                             │   │  │
│  │  │                    ▼ (VPA ajuste)                │   │  │
│  │  │  ┌──────────────────────────────────────┐        │   │  │
│  │  │  │  Optimisé                            │        │   │  │
│  │  │  │  ┌────────────────┐                  │        │   │  │
│  │  │  │  │   Pod          │                  │        │   │  │
│  │  │  │  │   CPU: 1000m   │                  │        │   │  │
│  │  │  │  │   RAM: 2Gi     │                  │        │   │  │
│  │  │  │  └────────────────┘                  │        │   │  │
│  │  │  └──────────────────────────────────────┘        │   │  │
│  │  │                                                   │   │  │
│  │  │  • Ajuste CPU/RAM par pod                        │   │  │
│  │  │  • Basé sur l'utilisation historique             │   │  │
│  │  │  • Modes: Off, Initial, Recreate, Auto           │   │  │
│  │  └──────────────────────────────────────────────────┘   │  │
│  └─────────────────────────────────────────────────────────┘  │
│                                                                │
│  ┌─────────────────────────────────────────────────────────┐  │
│  │  PDB (PodDisruptionBudget)                               │  │
│  │  ┌──────────────────────────────────────────────────┐   │  │
│  │  │                                                   │   │  │
│  │  │  PodDisruptionBudget: web-pdb                    │   │  │
│  │  │    minAvailable: 2                               │   │  │
│  │  │    ou                                            │   │  │
│  │  │    maxUnavailable: 1                             │   │  │
│  │  │                                                   │   │  │
│  │  │  Deployment avec 5 répliques                     │   │  │
│  │  │  ┌────┐ ┌────┐ ┌────┐ ┌────┐ ┌────┐             │   │  │
│  │  │  │Pod1│ │Pod2│ │Pod3│ │Pod4│ │Pod5│             │   │  │
│  │  │  └────┘ └────┘ └────┘ └────┘ └────┘             │   │  │
│  │  │                                                   │   │  │
│  │  │  Pendant maintenance (drain node):               │   │  │
│  │  │  ┌────┐ ┌────┐ ┌────┐ ┌────┐  ❌                │   │  │
│  │  │  │Pod1│ │Pod2│ │Pod3│ │Pod4│ (max 1 unavailable)│  │
│  │  │  └────┘ └────┘ └────┘ └────┘                     │   │  │
│  │  │    ✓      ✓      ✓      ✓                       │   │  │
│  │  │  (au moins 4 disponibles respecte minAvailable:2)│  │
│  │  │                                                   │   │  │
│  │  │  • Garantit disponibilité pendant disruptions    │   │  │
│  │  │  • Utilisé lors: drain, upgrade, scaling down    │   │  │
│  │  │  • Empêche interruptions simultanées excessives  │   │  │
│  │  └──────────────────────────────────────────────────┘   │  │
│  └─────────────────────────────────────────────────────────┘  │
│                                                                │
└────────────────────────────────────────────────────────────────┘
```

---

## 4. Relations entre les ressources

### 4.1 Vue d'ensemble des relations

```
┌────────────────────────────────────────────────────────────────────┐
│                     RELATIONS ENTRE RESSOURCES                     │
└────────────────────────────────────────────────────────────────────┘

NAMESPACE
  │
  ├─► DEPLOYMENT ──────┬──► REPLICASET ──► PODS
  │                    │                      │
  │                    └──► ConfigMap ────────┤
  │                    └──► Secret ───────────┤
  │                    └──► ServiceAccount ───┤
  │                                           │
  ├─► SERVICE ──────────────────────────────► │ (sélectionne)
  │      │                                    │
  │      └──► ENDPOINTS ──────────────────────┘
  │
  ├─► INGRESS ─────────────► SERVICE ─────────► PODS
  │
  ├─► PERSISTENTVOLUMECLAIM ──► PERSISTENTVOLUME
  │      │                            │
  │      │                            │
  │      └──► POD ◄────────────────────┘ (monte)
  │
  ├─► ROLE ────────┐
  ├─► ROLEBINDING ─┴──► ServiceAccount ──► POD
  │
  ├─► NETWORKPOLICY ──────────────────────► POD (sélectionne)
  │
  ├─► HPA ─────────────────► DEPLOYMENT ───► Scaling
  │
  └─► PDB ─────────────────► DEPLOYMENT ───► Disponibilité


CLUSTER LEVEL (pas de namespace)
  │
  ├─► NODES ──────────────────────────────► PODS (hébergent)
  │
  ├─► PERSISTENTVOLUMES
  │
  ├─► STORAGECLASSES ─────────────────────► PV (provisionne)
  │
  ├─► CLUSTERROLE ────────┐
  ├─► CLUSTERROLEBINDING ─┴───────────────► ServiceAccount
  │
  └─► NAMESPACE ──────────────────────────► (contient ressources)
```

### 4.2 Flux de déploiement complet

```
┌────────────────────────────────────────────────────────────────────┐
│          FLUX DE DÉPLOIEMENT D'UNE APPLICATION COMPLÈTE            │
└────────────────────────────────────────────────────────────────────┘

1. CRÉATION DES RESSOURCES DE BASE
   │
   ├─► Namespace: production
   ├─► ConfigMap: app-config
   ├─► Secret: db-credentials
   ├─► ServiceAccount: app-sa
   ├─► StorageClass: fast-ssd
   └─► Role + RoleBinding

2. DÉPLOIEMENT BASE DE DONNÉES
   │
   ├─► PersistentVolumeClaim: db-pvc ──► PV (auto-provisionné)
   │
   ├─► StatefulSet: mysql
   │      │
   │      ├─► ReplicaSet
   │      │     │
   │      │     └─► Pods: mysql-0, mysql-1, mysql-2
   │      │           │
   │      │           ├─► Monte: db-pvc
   │      │           ├─► Utilise: db-credentials
   │      │           └─► ServiceAccount: app-sa
   │      │
   │      └─► Service Headless: mysql-svc
   │             │
   │             └─► DNS: mysql-0.mysql-svc.production.svc.cluster.local

3. DÉPLOIEMENT APPLICATION
   │
   ├─► Deployment: web-app
   │      │
   │      ├─► ReplicaSet
   │      │     │
   │      │     └─► Pods: web-app-xxxxx (3 replicas)
   │      │           │
   │      │           ├─► Utilise: app-config (ConfigMap)
   │      │           ├─► Utilise: db-credentials (Secret)
   │      │           ├─► ServiceAccount: app-sa
   │      │           └─► Connecte à: mysql-svc
   │      │
   │      └─► HPA: web-app-hpa
   │            │
   │            └─► Scale: 3-10 replicas (CPU > 70%)

4. EXPOSITION
   │
   ├─► Service: web-app-svc (ClusterIP)
   │      │
   │      └─► Sélectionne: Pods web-app-xxxxx
   │
   └─► Ingress: web-app-ingress
          │
          ├─► Rules:
          │   ├─► app.example.com/     ──► web-app-svc:80
          │   └─► app.example.com/api  ──► api-svc:8080
          │
          └─► TLS: app.example.com (depuis Secret)

5. SÉCURITÉ
   │
   ├─► NetworkPolicy: web-app-netpol
   │      │
   │      ├─► Ingress: Autorise depuis Ingress Controller
   │      └─► Egress: Autorise vers mysql-svc uniquement
   │
   └─► PodSecurityPolicy / PodSecurityStandard: restricted

6. DISPONIBILITÉ
   │
   └─► PodDisruptionBudget: web-app-pdb
          │
          └─► minAvailable: 2 (garantit toujours 2 pods actifs)


RÉSULTAT FINAL:

Internet
   │
   ▼
Ingress Controller (NGINX)
   │
   ▼
Ingress (app.example.com)
   │
   ▼
Service: web-app-svc
   │
   ├──► Pod: web-app-xxxxx-1 ──┐
   ├──► Pod: web-app-xxxxx-2 ──┼──► Service: mysql-svc ──► StatefulSet
   └──► Pod: web-app-xxxxx-3 ──┘                              │
                                                               ├─► mysql-0
        ↑ Auto-scaled par HPA                                  ├─► mysql-1
        ↑ Protégé par PDB                                      └─► mysql-2
        ↑ Isolé par NetworkPolicy                                    │
        ↑ Contrôlé par RBAC                                          ▼
                                                           PersistentVolume
```

---

## 5. Flux de déploiement

### 5.1 Cycle de vie d'un Pod

```
┌────────────────────────────────────────────────────────────────────┐
│                    CYCLE DE VIE D'UN POD                           │
└────────────────────────────────────────────────────────────────────┘

1. CRÉATION
   │
   User ──► kubectl apply -f deployment.yaml
   │
   ▼
   API Server ──► Validation ──► etcd (sauvegarde)
   │
   ▼
   Controller Manager détecte nouveau Deployment
   │
   ▼
   Crée ReplicaSet
   │
   ▼
   ReplicaSet Controller crée les Pods

2. SCHEDULING
   │
   Scheduler surveille les Pods sans Node assigné
   │
   ▼
   Évalue les Nodes:
   ├─► Ressources disponibles (CPU, RAM)
   ├─► Node Selectors
   ├─► Affinity / Anti-affinity
   ├─► Taints / Tolerations
   └─► Contraintes personnalisées
   │
   ▼
   Assigne Pod au Node optimal
   │
   ▼
   Met à jour etcd

3. DÉMARRAGE SUR LE NODE
   │
   kubelet (sur le Node) détecte nouveau Pod assigné
   │
   ▼
   Télécharge l'image du conteneur
   │
   ▼
   Crée le réseau Pod (CNI)
   │
   ▼
   Monte les volumes
   │
   ▼
   Exécute InitContainers (séquentiellement)
   │
   ├─► InitContainer 1 (ex: migration DB) ──► Complete
   ├─► InitContainer 2 (ex: config setup)  ──► Complete
   │
   ▼
   Démarre les conteneurs applicatifs (parallèlement)
   │
   ├─► Container 1 (app principale)
   ├─► Container 2 (sidecar logs)
   └─► Container 3 (proxy)

4. EXÉCUTION
   │
   État: Running
   │
   ├─► Liveness Probe ──► Vérifie si app répond
   │     │
   │     └─► Échec ──► Redémarre conteneur
   │
   ├─► Readiness Probe ──► Vérifie si prêt pour trafic
   │     │
   │     └─► Échec ──► Retire des Endpoints Service
   │
   └─► Startup Probe ──► Attend démarrage complet
         │
         └─► Échec ──► Redémarre Pod

5. MISE À JOUR (Rolling Update)
   │
   kubectl set image deployment/app app=v2.0
   │
   ▼
   Deployment Controller crée nouveau ReplicaSet (v2.0)
   │
   ▼
   ┌─────────────────────────────────────────┐
   │ ReplicaSet v1.0: 3 pods                 │
   │ ReplicaSet v2.0: 0 pods                 │
   └─────────────────────────────────────────┘
   │
   ▼ (maxSurge: 1, maxUnavailable: 0)
   ┌─────────────────────────────────────────┐
   │ ReplicaSet v1.0: 3 pods (running)       │
   │ ReplicaSet v2.0: 1 pod  (creating)      │
   └─────────────────────────────────────────┘
   │
   ▼ (v2.0 pod ready)
   ┌─────────────────────────────────────────┐
   │ ReplicaSet v1.0: 2 pods (terminating 1) │
   │ ReplicaSet v2.0: 2 pods (creating 1)    │
   └─────────────────────────────────────────┘
   │
   ▼ (continuer jusqu'à complétion)
   ┌─────────────────────────────────────────┐
   │ ReplicaSet v1.0: 0 pods                 │
   │ ReplicaSet v2.0: 3 pods (running)       │
   └─────────────────────────────────────────┘

6. TERMINAISON
   │
   kubectl delete pod <pod-name>
   ou
   Node failure / OOMKilled / Error
   │
   ▼
   État: Terminating
   │
   ├─► PreStop Hook s'exécute
   │
   ├─► SIGTERM envoyé aux conteneurs
   │
   ├─► Grace period (30s par défaut)
   │     │
   │     └─► Application peut terminer proprement
   │
   ├─► Si pas terminé après grace period ──► SIGKILL
   │
   ▼
   État: Terminated
   │
   ├─► Volumes démontés
   ├─► Réseau Pod supprimé
   └─► Ressources libérées


ÉTATS DU POD:

Pending       ──► Création, en attente de scheduling
ContainerCreating ──► Images en téléchargement
Running       ──► Au moins 1 conteneur actif
Succeeded     ──► Tous conteneurs terminés avec succès (Jobs)
Failed        ──► Au moins 1 conteneur en erreur
Unknown       ──► État inconnu (communication perdue)
CrashLoopBackOff ──► Redémarrages répétés après crashes
```

### 5.2 Flux réseau d'une requête

```
┌────────────────────────────────────────────────────────────────────┐
│              FLUX RÉSEAU D'UNE REQUÊTE UTILISATEUR                 │
└────────────────────────────────────────────────────────────────────┘

1. REQUÊTE EXTERNE
   │
   User Browser ──► https://app.example.com/api/users
   │
   ▼
   DNS résolution ──► IP du LoadBalancer externe
   │
   ▼
   LoadBalancer (Cloud Provider)
   │
   ▼
   Node IP:443 (NodePort du Ingress Controller)

2. INGRESS LAYER
   │
   NGINX Ingress Controller Pod
   │
   ├─► Vérifie TLS/SSL (termination)
   ├─► Vérifie Ingress Rules
   │     │
   │     ├─► Host: app.example.com ✓
   │     └─► Path: /api/* ✓
   │
   ▼
   Résout Service: api-svc.production.svc.cluster.local
   │
   ▼
   Forward vers ClusterIP: 10.96.0.50:8080

3. SERVICE LAYER
   │
   Service: api-svc (ClusterIP: 10.96.0.50)
   │
   ├─► Type: ClusterIP
   ├─► Selector: app=api
   ├─► Port: 8080
   │
   ▼
   kube-proxy (iptables/ipvs rules)
   │
   ├─► Lit Endpoints (liste des Pod IPs)
   │
   ▼
   Load balancing vers un Pod:
   │
   ├─► Pod 1: 10.244.1.10:8080 (33% traffic)
   ├─► Pod 2: 10.244.1.11:8080 (33% traffic)
   └─► Pod 3: 10.244.2.12:8080 (33% traffic)
   │
   ▼ (sélectionne Pod 2)

4. POD LAYER
   │
   Pod: api-xxxxx-2 (IP: 10.244.1.11)
   │
   ├─► NetworkPolicy vérifie
   │     │
   │     ├─► Ingress autorisé depuis Ingress Controller ✓
   │     └─► Egress autorisé vers db-svc ✓
   │
   ▼
   Conteneur application (port 8080)
   │
   ├─► Application traite requête
   ├─► Lit ConfigMap (variables env)
   ├─► Lit Secret (DB credentials)
   │
   ▼
   Besoin d'accéder à la base de données
   │
   ▼
   Résout: mysql-svc.production.svc.cluster.local
   │
   ▼
   Service: mysql-svc (Headless)

5. CONNEXION BASE DE DONNÉES
   │
   Service Headless: mysql-svc
   │
   ├─► ClusterIP: None
   ├─► Retourne directement les IPs des Pods
   │
   ▼
   DNS retourne:
   ├─► mysql-0.mysql-svc: 10.244.1.20
   ├─► mysql-1.mysql-svc: 10.244.1.21
   └─► mysql-2.mysql-svc: 10.244.1.22
   │
   ▼
   Application se connecte à mysql-0 (master)
   │
   Pod: mysql-0 (StatefulSet)
   │
   ├─► Lit données depuis PersistentVolume
   ├─► Retourne résultat
   │
   ▼
   Réponse remonte

6. RÉPONSE
   │
   mysql-0 ──► api-xxxxx-2 ──► Service api-svc
   │
   ▼
   Ingress Controller
   │
   ├─► Ajoute headers
   ├─► Encode réponse (gzip si configuré)
   │
   ▼
   LoadBalancer
   │
   ▼
   User Browser
   │
   └─► Affiche: {"users": [...]}


LATENCE TYPIQUE:

Internet → LB          : ~5-50 ms
LB → Ingress           : ~1-5 ms
Ingress → Service      : ~1 ms
Service → Pod          : <1 ms
Pod → DB Service       : <1 ms
DB Pod query           : ~10-100 ms
────────────────────────────────
Total                  : ~20-160 ms
```

---

## 6. Namespace et isolation

```
┌────────────────────────────────────────────────────────────────────┐
│                    NAMESPACES ET ISOLATION                         │
└────────────────────────────────────────────────────────────────────┘

CLUSTER
  │
  ├─► default (namespace par défaut)
  │     │
  │     ├─► Pods
  │     ├─► Services
  │     └─► ConfigMaps
  │
  ├─► kube-system (composants Kubernetes)
  │     │
  │     ├─► kube-dns / CoreDNS
  │     ├─► kube-proxy
  │     ├─► metrics-server
  │     └─► Ingress Controllers
  │
  ├─► kube-public (accessible à tous)
  │     │
  │     └─► cluster-info ConfigMap
  │
  ├─► kube-node-lease (heartbeats des nodes)
  │
  ├─► development (environnement dev)
  │     │
  │     ├─► ResourceQuota:
  │     │     ├─► CPU: 10 cores max
  │     │     ├─► Memory: 20Gi max
  │     │     └─► Pods: 50 max
  │     │
  │     ├─► LimitRange:
  │     │     ├─► Pod CPU: 100m-2000m
  │     │     └─► Pod Memory: 128Mi-4Gi
  │     │
  │     ├─► NetworkPolicy: Isolé des autres namespaces
  │     │
  │     └─► Ressources applicatives
  │
  ├─► staging (environnement de test)
  │     │
  │     ├─► ResourceQuota différent
  │     ├─► NetworkPolicy différente
  │     └─► Ressources applicatives
  │
  └─► production (environnement prod)
        │
        ├─► ResourceQuota: Limites élevées
        ├─► NetworkPolicy: Strictement contrôlé
        ├─► PodSecurityStandard: Restricted
        └─► Ressources applicatives


ISOLATION PAR NAMESPACE:

┌──────────────────┐      ┌──────────────────┐      ┌──────────────────┐
│  development     │      │  staging         │      │  production      │
│                  │      │                  │      │                  │
│  ┌────┐  ┌────┐ │      │  ┌────┐  ┌────┐ │      │  ┌────┐  ┌────┐ │
│  │Pod1│  │Pod2│ │  ✗   │  │Pod1│  │Pod2│ │  ✗   │  │Pod1│  │Pod2│ │
│  └────┘  └────┘ │      │  └────┘  └────┘ │      │  └────┘  └────┘ │
│                  │      │                  │      │                  │
│  Service: api    │      │  Service: api    │      │  Service: api    │
└──────────────────┘      └──────────────────┘      └──────────────────┘
        │                         │                         │
        └─────────────────────────┴─────────────────────────┘
                  (Isolés par NetworkPolicy)


Communication cross-namespace (si autorisée):
  Service FQDN: <service>.<namespace>.svc.cluster.local

  Exemple depuis development:
    curl http://api.production.svc.cluster.local
```

---

## 7. Commandes de référence rapide

```bash
# NAMESPACES
kubectl get namespaces
kubectl create namespace production
kubectl config set-context --current --namespace=production

# PODS
kubectl get pods -A
kubectl describe pod <pod-name>
kubectl logs <pod-name> -c <container-name>
kubectl exec -it <pod-name> -- /bin/bash

# DEPLOYMENTS
kubectl get deployments
kubectl create deployment nginx --image=nginx:latest
kubectl scale deployment nginx --replicas=5
kubectl rollout status deployment/nginx
kubectl rollout undo deployment/nginx

# SERVICES
kubectl get services
kubectl expose deployment nginx --port=80 --type=LoadBalancer
kubectl get endpoints

# CONFIGMAPS & SECRETS
kubectl create configmap app-config --from-file=config.properties
kubectl create secret generic db-secret --from-literal=password=secret123
kubectl get configmaps
kubectl get secrets

# STORAGE
kubectl get pv
kubectl get pvc
kubectl get storageclasses

# RBAC
kubectl get serviceaccounts
kubectl get roles
kubectl get rolebindings
kubectl get clusterroles
kubectl get clusterrolebindings

# NETWORKING
kubectl get ingress
kubectl get networkpolicies

# AUTOSCALING
kubectl get hpa
kubectl autoscale deployment nginx --min=2 --max=10 --cpu-percent=80

# DEBUG
kubectl describe <resource> <name>
kubectl logs <pod-name> --previous
kubectl top nodes
kubectl top pods
kubectl get events --sort-by='.lastTimestamp'

# APPLY / DELETE
kubectl apply -f manifest.yaml
kubectl delete -f manifest.yaml
kubectl apply -f directory/
```

---

## Conclusion

Ce schéma couvre toutes les ressources Kubernetes principales et leurs relations. Pour approfondir :

- **[TP1](../tp1/README.md)** - Premiers pas avec Kubernetes
- **[TP2](../tp2/README.md)** - Maîtriser les manifests
- **[TP3](../tp3/README.md)** - Persistance des données
- **[TP4](../tp4/README.md)** - Monitoring et logs
- **[TP5](../tp5/README.md)** - Sécurité et RBAC
- **[TP6](../tp6/README.md)** - CI/CD et production
- **[TP8](../tp8/README.md)** - Réseau Kubernetes
- **[TP9](../tp9/README.md)** - Gestion multi-nœuds

Pour plus d'informations :
- **[Documentation officielle Kubernetes](https://kubernetes.io/docs/)**
- **[kubectl Reference](KUBECTL_KUBEADM_MINIKUBE_REFERENCE.md)**
- **[Tips & Tricks](TIPS_AND_TRICKS.md)**
