# Déploiement MySQL avec sécurité renforcée
# Ce fichier démontre les best practices de sécurité pour le stockage dans Kubernetes

---
# PVC avec StorageClass par défaut (ou adaptez selon votre environnement)
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: mysql-pvc-secure
  labels:
    app: mysql
    tier: database
    environment: production
spec:
  storageClassName: standard  # Remplacer par une classe avec chiffrement en production
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: 10Gi

---
# Secret pour les credentials MySQL
# ⚠️ En production, utiliser un gestionnaire de secrets externe (Vault, Sealed Secrets, External Secrets Operator)
# ou kubectl create secret au lieu de committer le secret dans Git
apiVersion: v1
kind: Secret
metadata:
  name: mysql-secret-secure
  labels:
    app: mysql
type: Opaque
data:
  # Ces valeurs DOIVENT être générées et stockées de manière sécurisée
  # echo -n 'VotreMotDePasseComplexe!2024' | base64
  mysql-root-password: Vm90cmVNb3REZVBhc3NlQ29tcGxleGUhMjAyNA==
  # echo -n 'app_production' | base64
  mysql-database: YXBwX3Byb2R1Y3Rpb24=
  # echo -n 'appuser' | base64
  mysql-user: YXBwdXNlcg==
  # echo -n 'AppUserPassword!2024' | base64
  mysql-password: QXBwVXNlclBhc3N3b3JkITIwMjQ=

---
# ConfigMap pour la configuration MySQL personnalisée
apiVersion: v1
kind: ConfigMap
metadata:
  name: mysql-config-secure
  labels:
    app: mysql
data:
  # Configuration MySQL avec paramètres de sécurité renforcés
  my.cnf: |
    [mysqld]
    # Sécurité
    skip-name-resolve
    skip-symbolic-links
    local-infile=0

    # Logging pour audit
    log_error=/var/log/mysql/error.log
    slow_query_log=1
    slow_query_log_file=/var/log/mysql/slow.log
    long_query_time=2

    # Performance
    max_connections=150
    max_allowed_packet=64M
    innodb_buffer_pool_size=256M
    innodb_log_file_size=64M

    # Character set
    character-set-server=utf8mb4
    collation-server=utf8mb4_unicode_ci

    # Binlog pour backup
    log_bin=/var/lib/mysql/mysql-bin
    expire_logs_days=7
    max_binlog_size=100M

    # SSL/TLS (optionnel, nécessite certificats TLS)
    # require_secure_transport=ON
    # Configuration des certificats dans /etc/mysql/certs/

---
# ServiceAccount dédié pour MySQL
apiVersion: v1
kind: ServiceAccount
metadata:
  name: mysql-sa
  labels:
    app: mysql
automountServiceAccountToken: false  # Sécurité: ne pas monter le token si non nécessaire

---
# NetworkPolicy pour limiter l'accès à MySQL
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: mysql-network-policy
  labels:
    app: mysql
spec:
  podSelector:
    matchLabels:
      app: mysql
      tier: database
  policyTypes:
  - Ingress
  - Egress
  ingress:
  # Autoriser uniquement les pods avec le label "access-mysql: true"
  - from:
    - podSelector:
        matchLabels:
          access-mysql: "true"
    ports:
    - protocol: TCP
      port: 3306
  egress:
  # Autoriser uniquement les requêtes DNS et les réponses
  - to:
    - namespaceSelector:
        matchLabels:
          name: kube-system
    ports:
    - protocol: UDP
      port: 53

---
# Deployment MySQL avec sécurité renforcée
apiVersion: apps/v1
kind: Deployment
metadata:
  name: mysql-secure
  labels:
    app: mysql
    tier: database
    environment: production
spec:
  replicas: 1  # MySQL standalone (pour HA, utiliser un StatefulSet ou un opérateur)
  strategy:
    type: Recreate  # Important pour les bases de données avec PVC
  selector:
    matchLabels:
      app: mysql
      tier: database
  template:
    metadata:
      labels:
        app: mysql
        tier: database
        access-mysql: "false"  # Le pod MySQL lui-même n'a pas besoin d'accéder à MySQL
      annotations:
        # Prometheus monitoring (si installé)
        prometheus.io/scrape: "true"
        prometheus.io/port: "9104"
    spec:
      serviceAccountName: mysql-sa

      # Security Context au niveau Pod
      securityContext:
        runAsNonRoot: true
        runAsUser: 999       # UID de l'utilisateur mysql dans l'image officielle
        runAsGroup: 999
        fsGroup: 999         # Groupe propriétaire des volumes
        fsGroupChangePolicy: "OnRootMismatch"
        seccompProfile:
          type: RuntimeDefault

      # Init container pour vérifier et préparer le volume
      initContainers:
      - name: volume-permissions
        image: busybox:1.36
        command:
        - sh
        - -c
        - |
          echo "Checking volume permissions..."
          ls -la /var/lib/mysql
          echo "Volume is ready"
        volumeMounts:
        - name: mysql-storage
          mountPath: /var/lib/mysql
        - name: init-tmp
          mountPath: /tmp
        securityContext:
          runAsUser: 999
          runAsGroup: 999
          allowPrivilegeEscalation: false
          readOnlyRootFilesystem: true
          capabilities:
            drop:
            - ALL

      containers:
      # Container MySQL principal
      - name: mysql
        image: mysql:8.0.35  # Version spécifique pour la reproductibilité
        imagePullPolicy: IfNotPresent

        ports:
        - containerPort: 3306
          name: mysql
          protocol: TCP

        # Variables d'environnement depuis le Secret
        env:
        - name: MYSQL_ROOT_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mysql-secret-secure
              key: mysql-root-password
        - name: MYSQL_DATABASE
          valueFrom:
            secretKeyRef:
              name: mysql-secret-secure
              key: mysql-database
        - name: MYSQL_USER
          valueFrom:
            secretKeyRef:
              name: mysql-secret-secure
              key: mysql-user
        - name: MYSQL_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mysql-secret-secure
              key: mysql-password

        # Volumes montés
        volumeMounts:
        - name: mysql-storage
          mountPath: /var/lib/mysql
          subPath: data  # Sous-répertoire pour éviter les conflits
        - name: mysql-config
          mountPath: /etc/mysql/conf.d
          readOnly: true
        - name: mysql-logs
          mountPath: /var/log/mysql
        - name: tmp
          mountPath: /tmp
        - name: run
          mountPath: /var/run/mysqld

        # Security Context au niveau container
        securityContext:
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
            add:
            - NET_BIND_SERVICE  # Nécessaire pour écouter sur le port 3306
          readOnlyRootFilesystem: true  # Filesystem en lecture seule, volumes montés pour écriture

        # Ressources limitées
        resources:
          requests:
            memory: "512Mi"
            cpu: "500m"
          limits:
            memory: "1Gi"
            cpu: "1000m"

        # Probes de santé
        livenessProbe:
          exec:
            command:
            - mysqladmin
            - ping
            - -h
            - localhost
          initialDelaySeconds: 30
          periodSeconds: 10
          timeoutSeconds: 5
          failureThreshold: 3

        readinessProbe:
          exec:
            command:
            - mysql
            - -h
            - localhost
            - -e
            - SELECT 1
          initialDelaySeconds: 10
          periodSeconds: 5
          timeoutSeconds: 2
          failureThreshold: 3

        # Startup probe pour le démarrage initial
        startupProbe:
          exec:
            command:
            - mysqladmin
            - ping
            - -h
            - localhost
          initialDelaySeconds: 10
          periodSeconds: 5
          timeoutSeconds: 2
          failureThreshold: 30  # 30 * 5 = 150 secondes max pour démarrer

      # Sidecar pour exporter les métriques Prometheus (optionnel)
      - name: mysql-exporter
        image: prom/mysqld-exporter:v0.15.1
        ports:
        - containerPort: 9104
          name: metrics
        env:
        - name: DATA_SOURCE_NAME
          value: "exporter:$(MYSQL_EXPORTER_PASSWORD)@(localhost:3306)/"
        - name: MYSQL_EXPORTER_PASSWORD
          valueFrom:
            secretKeyRef:
              name: mysql-secret-secure
              key: mysql-password
        securityContext:
          runAsNonRoot: true
          runAsUser: 65534  # nobody
          allowPrivilegeEscalation: false
          capabilities:
            drop:
            - ALL
          readOnlyRootFilesystem: true
        resources:
          requests:
            memory: "32Mi"
            cpu: "50m"
          limits:
            memory: "64Mi"
            cpu: "100m"

      volumes:
      # Volume persistant pour les données
      - name: mysql-storage
        persistentVolumeClaim:
          claimName: mysql-pvc-secure

      # ConfigMap pour la configuration
      - name: mysql-config
        configMap:
          name: mysql-config-secure
          defaultMode: 0444  # r--r--r--

      # emptyDir pour les logs (à remplacer par un système de logging centralisé)
      - name: mysql-logs
        emptyDir:
          sizeLimit: 1Gi

      # emptyDir pour /tmp du container principal (évite les écritures sur le filesystem principal)
      - name: tmp
        emptyDir:
          sizeLimit: 500Mi

      # emptyDir pour /tmp de l'init container
      - name: init-tmp
        emptyDir:
          sizeLimit: 100Mi

      # emptyDir pour /var/run/mysqld
      - name: run
        emptyDir:
          medium: Memory  # En RAM pour de meilleures performances
          sizeLimit: 100Mi

---
# Service Headless pour MySQL (accès direct au pod)
apiVersion: v1
kind: Service
metadata:
  name: mysql-secure
  labels:
    app: mysql
    tier: database
spec:
  selector:
    app: mysql
    tier: database
  ports:
  - port: 3306
    targetPort: 3306
    protocol: TCP
    name: mysql
  clusterIP: None  # Headless service

---
# Service standard pour MySQL (avec IP cluster)
apiVersion: v1
kind: Service
metadata:
  name: mysql-secure-svc
  labels:
    app: mysql
    tier: database
spec:
  selector:
    app: mysql
    tier: database
  ports:
  - port: 3306
    targetPort: 3306
    protocol: TCP
    name: mysql
  type: ClusterIP
  sessionAffinity: ClientIP  # Maintenir la session sur le même pod

---
# PodDisruptionBudget pour assurer la disponibilité
apiVersion: policy/v1
kind: PodDisruptionBudget
metadata:
  name: mysql-pdb
spec:
  minAvailable: 1
  selector:
    matchLabels:
      app: mysql
      tier: database
