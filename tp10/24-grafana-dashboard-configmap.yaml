apiVersion: v1
kind: ConfigMap
metadata:
  name: grafana-dashboards
  namespace: taskflow
  labels:
    app: grafana
    component: dashboards
data:
  taskflow-overview.json: |
    {
      "id": null,
      "uid": "taskflow-overview",
      "title": "TaskFlow - Overview & Auto-scaling",
      "tags": ["kubernetes", "taskflow", "autoscaling"],
      "timezone": "browser",
      "schemaVersion": 27,
      "version": 1,
      "refresh": "10s",
      "time": {
        "from": "now-15m",
        "to": "now"
      },
      "timepicker": {
        "refresh_intervals": ["5s", "10s", "30s", "1m", "5m"]
      },
      "annotations": {
        "list": []
      },
        "panels": [
          {
            "id": 1,
            "gridPos": {"h": 1, "w": 24, "x": 0, "y": 0},
            "type": "row",
            "title": "üìä Vue d'ensemble - √âtat de l'application"
          },
          {
            "id": 2,
            "gridPos": {"h": 4, "w": 6, "x": 0, "y": 1},
            "type": "stat",
            "title": "Pods Running",
            "targets": [
              {
                "expr": "count(up{job=\"kubernetes-pods\", namespace=\"taskflow\"} == 1)",
                "refId": "A"
              }
            ],
            "options": {
              "graphMode": "none",
              "colorMode": "background",
              "justifyMode": "center",
              "textMode": "value_and_name"
            },
            "fieldConfig": {
              "defaults": {
                "thresholds": {
                  "mode": "absolute",
                  "steps": [
                    {"value": 0, "color": "red"},
                    {"value": 3, "color": "yellow"},
                    {"value": 5, "color": "green"}
                  ]
                },
                "unit": "short"
              }
            }
          },
          {
            "id": 3,
            "gridPos": {"h": 4, "w": 6, "x": 6, "y": 1},
            "type": "stat",
            "title": "Backend Pods (HPA)",
            "targets": [
              {
                "expr": "count(up{job=\"kubernetes-pods\", namespace=\"taskflow\", app=\"backend-api\"} == 1)",
                "refId": "A"
              }
            ],
            "options": {
              "graphMode": "area",
              "colorMode": "background",
              "justifyMode": "center"
            },
            "fieldConfig": {
              "defaults": {
                "thresholds": {
                  "mode": "absolute",
                  "steps": [
                    {"value": 0, "color": "red"},
                    {"value": 2, "color": "green"},
                    {"value": 8, "color": "yellow"},
                    {"value": 10, "color": "red"}
                  ]
                },
                "unit": "short",
                "min": 0,
                "max": 10
              }
            },
            "description": "Nombre de pods backend-api actifs (min=2, max=10)"
          },
          {
            "id": 4,
            "gridPos": {"h": 4, "w": 6, "x": 12, "y": 1},
            "type": "stat",
            "title": "PostgreSQL",
            "targets": [
              {
                "expr": "up{job=\"kubernetes-pods\", namespace=\"taskflow\", app=\"postgres\"}",
                "refId": "A"
              }
            ],
            "options": {
              "graphMode": "none",
              "colorMode": "background"
            },
            "fieldConfig": {
              "defaults": {
                "thresholds": {
                  "mode": "absolute",
                  "steps": [
                    {"value": 0, "color": "red"},
                    {"value": 1, "color": "green"}
                  ]
                },
                "mappings": [
                  {"type": "value", "value": "0", "text": "DOWN"},
                  {"type": "value", "value": "1", "text": "UP"}
                ]
              }
            }
          },
          {
            "id": 5,
            "gridPos": {"h": 4, "w": 6, "x": 18, "y": 1},
            "type": "stat",
            "title": "Redis Cache",
            "targets": [
              {
                "expr": "up{job=\"kubernetes-pods\", namespace=\"taskflow\", app=\"redis\"}",
                "refId": "A"
              }
            ],
            "options": {
              "graphMode": "none",
              "colorMode": "background"
            },
            "fieldConfig": {
              "defaults": {
                "thresholds": {
                  "mode": "absolute",
                  "steps": [
                    {"value": 0, "color": "red"},
                    {"value": 1, "color": "green"}
                  ]
                },
                "mappings": [
                  {"type": "value", "value": "0", "text": "DOWN"},
                  {"type": "value", "value": "1", "text": "UP"}
                ]
              }
            }
          },
          {
            "id": 10,
            "gridPos": {"h": 1, "w": 24, "x": 0, "y": 5},
            "type": "row",
            "title": "üöÄ Auto-scaling Backend API"
          },
          {
            "id": 11,
            "gridPos": {"h": 8, "w": 8, "x": 0, "y": 6},
            "type": "graph",
            "title": "Nombre de Pods Backend (√©volution)",
            "targets": [
              {
                "expr": "count(up{job=\"kubernetes-pods\", namespace=\"taskflow\", app=\"backend-api\"} == 1)",
                "refId": "A",
                "legendFormat": "Backend Pods"
              }
            ],
            "yaxes": [
              {"format": "short", "min": 0, "max": 12},
              {"format": "short"}
            ],
            "lines": true,
            "fill": 2,
            "linewidth": 2,
            "legend": {"show": true, "alignAsTable": true, "avg": true, "current": true, "max": true, "min": true},
            "tooltip": {"shared": true}
          },
          {
            "id": 12,
            "gridPos": {"h": 8, "w": 8, "x": 8, "y": 6},
            "type": "graph",
            "title": "CPU Usage - Backend Pods",
            "targets": [
              {
                "expr": "sum(rate(container_cpu_usage_seconds_total{namespace=\"taskflow\", pod=~\"backend-api.*\"}[1m])) * 100",
                "refId": "A",
                "legendFormat": "Total CPU %"
              },
              {
                "expr": "avg(rate(container_cpu_usage_seconds_total{namespace=\"taskflow\", pod=~\"backend-api.*\"}[1m])) * 100",
                "refId": "B",
                "legendFormat": "Avg CPU % per pod"
              }
            ],
            "yaxes": [
              {"format": "percent", "min": 0},
              {"format": "short"}
            ],
            "lines": true,
            "fill": 2,
            "linewidth": 2,
            "legend": {"show": true, "alignAsTable": true, "avg": true, "current": true, "max": true},
            "tooltip": {"shared": true},
            "thresholds": [
              {"value": 50, "colorMode": "custom", "op": "gt", "fill": true, "line": true, "fillColor": "rgba(255, 255, 0, 0.2)", "lineColor": "rgb(255, 255, 0)"}
            ]
          },
          {
            "id": 13,
            "gridPos": {"h": 8, "w": 8, "x": 16, "y": 6},
            "type": "graph",
            "title": "Memory Usage - Backend Pods",
            "targets": [
              {
                "expr": "sum(container_memory_usage_bytes{namespace=\"taskflow\", pod=~\"backend-api.*\"}) / 1024 / 1024",
                "refId": "A",
                "legendFormat": "Total Memory (MB)"
              },
              {
                "expr": "avg(container_memory_usage_bytes{namespace=\"taskflow\", pod=~\"backend-api.*\"}) / 1024 / 1024",
                "refId": "B",
                "legendFormat": "Avg Memory (MB) per pod"
              }
            ],
            "yaxes": [
              {"format": "mbytes", "min": 0},
              {"format": "short"}
            ],
            "lines": true,
            "fill": 2,
            "linewidth": 2,
            "legend": {"show": true, "alignAsTable": true, "avg": true, "current": true, "max": true},
            "tooltip": {"shared": true},
            "thresholds": [
              {"value": 180, "colorMode": "custom", "op": "gt", "fill": true, "line": true, "fillColor": "rgba(255, 255, 0, 0.2)", "lineColor": "rgb(255, 255, 0)"}
            ]
          },
          {
            "id": 20,
            "gridPos": {"h": 1, "w": 24, "x": 0, "y": 14},
            "type": "row",
            "title": "üíª M√©triques CPU - Tous les composants"
          },
          {
            "id": 21,
            "gridPos": {"h": 8, "w": 24, "x": 0, "y": 15},
            "type": "graph",
            "title": "CPU Usage par Pod",
            "targets": [
              {
                "expr": "rate(container_cpu_usage_seconds_total{namespace=\"taskflow\", pod=~\"backend-api.*\", container!=\"POD\", container!=\"\"}[1m]) * 100",
                "refId": "A",
                "legendFormat": "{{pod}}"
              },
              {
                "expr": "rate(container_cpu_usage_seconds_total{namespace=\"taskflow\", pod=~\"postgres.*\", container!=\"POD\", container!=\"\"}[1m]) * 100",
                "refId": "B",
                "legendFormat": "{{pod}}"
              },
              {
                "expr": "rate(container_cpu_usage_seconds_total{namespace=\"taskflow\", pod=~\"redis.*\", container!=\"POD\", container!=\"\"}[1m]) * 100",
                "refId": "C",
                "legendFormat": "{{pod}}"
              }
            ],
            "yaxes": [
              {"format": "percent", "min": 0},
              {"format": "short"}
            ],
            "lines": true,
            "fill": 1,
            "linewidth": 2,
            "legend": {"show": true, "alignAsTable": true, "avg": true, "current": true, "max": true, "values": true},
            "tooltip": {"shared": true, "sort": 2}
          },
          {
            "id": 30,
            "gridPos": {"h": 1, "w": 24, "x": 0, "y": 23},
            "type": "row",
            "title": "üß† M√©triques M√©moire - Tous les composants"
          },
          {
            "id": 31,
            "gridPos": {"h": 8, "w": 24, "x": 0, "y": 24},
            "type": "graph",
            "title": "Memory Usage par Pod",
            "targets": [
              {
                "expr": "container_memory_usage_bytes{namespace=\"taskflow\", pod=~\"backend-api.*\", container!=\"POD\", container!=\"\"} / 1024 / 1024",
                "refId": "A",
                "legendFormat": "{{pod}}"
              },
              {
                "expr": "container_memory_usage_bytes{namespace=\"taskflow\", pod=~\"postgres.*\", container!=\"POD\", container!=\"\"} / 1024 / 1024",
                "refId": "B",
                "legendFormat": "{{pod}}"
              },
              {
                "expr": "container_memory_usage_bytes{namespace=\"taskflow\", pod=~\"redis.*\", container!=\"POD\", container!=\"\"} / 1024 / 1024",
                "refId": "C",
                "legendFormat": "{{pod}}"
              }
            ],
            "yaxes": [
              {"format": "mbytes", "min": 0},
              {"format": "short"}
            ],
            "lines": true,
            "fill": 1,
            "linewidth": 2,
            "legend": {"show": true, "alignAsTable": true, "avg": true, "current": true, "max": true, "values": true},
            "tooltip": {"shared": true, "sort": 2}
          },
          {
            "id": 40,
            "gridPos": {"h": 1, "w": 24, "x": 0, "y": 32},
            "type": "row",
            "title": "üóÑÔ∏è Base de donn√©es PostgreSQL"
          },
          {
            "id": 41,
            "gridPos": {"h": 6, "w": 12, "x": 0, "y": 33},
            "type": "graph",
            "title": "PostgreSQL - CPU & Memory",
            "targets": [
              {
                "expr": "rate(container_cpu_usage_seconds_total{namespace=\"taskflow\", pod=~\"postgres.*\", container=\"postgres\"}[1m]) * 100",
                "refId": "A",
                "legendFormat": "CPU %"
              },
              {
                "expr": "container_memory_usage_bytes{namespace=\"taskflow\", pod=~\"postgres.*\", container=\"postgres\"} / 1024 / 1024",
                "refId": "B",
                "legendFormat": "Memory (MB)"
              }
            ],
            "yaxes": [
              {"format": "short", "min": 0},
              {"format": "short"}
            ],
            "lines": true,
            "fill": 2,
            "linewidth": 2,
            "legend": {"show": true, "alignAsTable": true, "avg": true, "current": true, "max": true},
            "tooltip": {"shared": true}
          },
          {
            "id": 42,
            "gridPos": {"h": 6, "w": 12, "x": 12, "y": 33},
            "type": "stat",
            "title": "PostgreSQL - √âtat",
            "targets": [
              {
                "expr": "up{job=\"kubernetes-pods\", namespace=\"taskflow\", app=\"postgres\"}",
                "refId": "A"
              }
            ],
            "options": {
              "graphMode": "area",
              "colorMode": "background"
            },
            "fieldConfig": {
              "defaults": {
                "thresholds": {
                  "mode": "absolute",
                  "steps": [
                    {"value": 0, "color": "red"},
                    {"value": 1, "color": "green"}
                  ]
                },
                "mappings": [
                  {"type": "value", "value": "0", "text": "DOWN ‚ùå"},
                  {"type": "value", "value": "1", "text": "UP ‚úÖ"}
                ]
              }
            },
            "description": "√âtat de la base de donn√©es PostgreSQL"
          },
          {
            "id": 50,
            "gridPos": {"h": 1, "w": 24, "x": 0, "y": 39},
            "type": "row",
            "title": "‚ö° Cache Redis"
          },
          {
            "id": 51,
            "gridPos": {"h": 6, "w": 12, "x": 0, "y": 40},
            "type": "graph",
            "title": "Redis - CPU & Memory",
            "targets": [
              {
                "expr": "rate(container_cpu_usage_seconds_total{namespace=\"taskflow\", pod=~\"redis.*\", container=\"redis\"}[1m]) * 100",
                "refId": "A",
                "legendFormat": "CPU %"
              },
              {
                "expr": "container_memory_usage_bytes{namespace=\"taskflow\", pod=~\"redis.*\", container=\"redis\"} / 1024 / 1024",
                "refId": "B",
                "legendFormat": "Memory (MB)"
              }
            ],
            "yaxes": [
              {"format": "short", "min": 0},
              {"format": "short"}
            ],
            "lines": true,
            "fill": 2,
            "linewidth": 2,
            "legend": {"show": true, "alignAsTable": true, "avg": true, "current": true, "max": true},
            "tooltip": {"shared": true}
          },
          {
            "id": 52,
            "gridPos": {"h": 6, "w": 12, "x": 12, "y": 40},
            "type": "stat",
            "title": "Redis - √âtat",
            "targets": [
              {
                "expr": "up{job=\"kubernetes-pods\", namespace=\"taskflow\", app=\"redis\"}",
                "refId": "A"
              }
            ],
            "options": {
              "graphMode": "area",
              "colorMode": "background"
            },
            "fieldConfig": {
              "defaults": {
                "thresholds": {
                  "mode": "absolute",
                  "steps": [
                    {"value": 0, "color": "red"},
                    {"value": 1, "color": "green"}
                  ]
                },
                "mappings": [
                  {"type": "value", "value": "0", "text": "DOWN ‚ùå"},
                  {"type": "value", "value": "1", "text": "UP ‚úÖ"}
                ]
              }
            },
            "description": "√âtat du cache Redis"
          },
          {
            "id": 60,
            "gridPos": {"h": 1, "w": 24, "x": 0, "y": 46},
            "type": "row",
            "title": "üì° M√©triques R√©seau"
          },
          {
            "id": 61,
            "gridPos": {"h": 6, "w": 12, "x": 0, "y": 47},
            "type": "graph",
            "title": "Network Received (Ingress)",
            "targets": [
              {
                "expr": "sum(rate(container_network_receive_bytes_total{namespace=\"taskflow\", pod=~\"backend-api.*\"}[1m])) / 1024",
                "refId": "A",
                "legendFormat": "Backend API"
              },
              {
                "expr": "sum(rate(container_network_receive_bytes_total{namespace=\"taskflow\", pod=~\"postgres.*\"}[1m])) / 1024",
                "refId": "B",
                "legendFormat": "PostgreSQL"
              },
              {
                "expr": "sum(rate(container_network_receive_bytes_total{namespace=\"taskflow\", pod=~\"redis.*\"}[1m])) / 1024",
                "refId": "C",
                "legendFormat": "Redis"
              }
            ],
            "yaxes": [
              {"format": "KBs", "min": 0},
              {"format": "short"}
            ],
            "lines": true,
            "fill": 1,
            "linewidth": 2,
            "legend": {"show": true, "alignAsTable": true, "avg": true, "current": true, "max": true},
            "tooltip": {"shared": true}
          },
          {
            "id": 62,
            "gridPos": {"h": 6, "w": 12, "x": 12, "y": 47},
            "type": "graph",
            "title": "Network Transmitted (Egress)",
            "targets": [
              {
                "expr": "sum(rate(container_network_transmit_bytes_total{namespace=\"taskflow\", pod=~\"backend-api.*\"}[1m])) / 1024",
                "refId": "A",
                "legendFormat": "Backend API"
              },
              {
                "expr": "sum(rate(container_network_transmit_bytes_total{namespace=\"taskflow\", pod=~\"postgres.*\"}[1m])) / 1024",
                "refId": "B",
                "legendFormat": "PostgreSQL"
              },
              {
                "expr": "sum(rate(container_network_transmit_bytes_total{namespace=\"taskflow\", pod=~\"redis.*\"}[1m])) / 1024",
                "refId": "C",
                "legendFormat": "Redis"
              }
            ],
            "yaxes": [
              {"format": "KBs", "min": 0},
              {"format": "short"}
            ],
            "lines": true,
            "fill": 1,
            "linewidth": 2,
            "legend": {"show": true, "alignAsTable": true, "avg": true, "current": true, "max": true},
            "tooltip": {"shared": true}
          }
        ]
    }
