# Exercice 2 : NetworkPolicies progressives
# Objectif : Sécuriser l'architecture 3-tiers de l'exercice 1
#
# Prérequis : Exercice 1 déployé
#
# Instructions :
# 1. Appliquer ce fichier : kubectl apply -f exercice-2-networkpolicies.yaml
# 2. Tester les restrictions
#
# Tests à effectuer :
# - Frontend toujours accessible depuis l'extérieur
# - Backend accessible uniquement depuis Frontend
# - Database accessible uniquement depuis Backend
# - DNS fonctionne pour tous les pods

---
# NetworkPolicy 1 : Deny all ingress par défaut
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: default-deny-ingress
  namespace: my-app
spec:
  podSelector: {}
  policyTypes:
  - Ingress

---
# NetworkPolicy 2 : Allow ingress to Frontend from anywhere
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-frontend-ingress
  namespace: my-app
spec:
  podSelector:
    matchLabels:
      tier: frontend
  policyTypes:
  - Ingress
  ingress:
  - ports:
    - protocol: TCP
      port: 80

---
# NetworkPolicy 3 : Allow Backend ingress from Frontend only
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-backend-from-frontend
  namespace: my-app
spec:
  podSelector:
    matchLabels:
      tier: backend
  policyTypes:
  - Ingress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          tier: frontend
    ports:
    - protocol: TCP
      port: 8080

---
# NetworkPolicy 4 : Allow Database ingress from Backend only
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-database-from-backend
  namespace: my-app
spec:
  podSelector:
    matchLabels:
      tier: database
  policyTypes:
  - Ingress
  - Egress
  ingress:
  - from:
    - podSelector:
        matchLabels:
          tier: backend
    ports:
    - protocol: TCP
      port: 5432
  egress:
  # Allow DNS
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: kube-system
    ports:
    - protocol: UDP
      port: 53

---
# NetworkPolicy 5 : Allow DNS for all pods
apiVersion: networking.k8s.io/v1
kind: NetworkPolicy
metadata:
  name: allow-dns-for-all
  namespace: my-app
spec:
  podSelector: {}
  policyTypes:
  - Egress
  egress:
  - to:
    - namespaceSelector:
        matchLabels:
          kubernetes.io/metadata.name: kube-system
    ports:
    - protocol: UDP
      port: 53
  # Allow communication within namespace
  - to:
    - podSelector: {}
